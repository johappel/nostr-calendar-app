<!DOCTYPE html>
<html>
<head>
    <title>NIP-26 Delegation Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üîê NIP-26 Delegation Test</h1>
    <p>Dieses Tool testet das neue 2-Schritt NIP-26 Delegation System.</p>
    
    <div class="step">
        <h3>1. Login Status</h3>
        <div id="login-status" class="status warning">Nicht eingeloggt</div>
        <button id="btn-check-login" class="btn-secondary">Login pr√ºfen</button>
    </div>

    <div class="step">
        <h3>2. Delegation vorbereiten</h3>
        <button id="btn-prepare" class="btn-primary" disabled>Delegation vorbereiten</button>
        <div id="prepare-result"></div>
    </div>

    <div class="step">
        <h3>3. Delegation signieren & abschlie√üen</h3>
        <button id="btn-complete" class="btn-primary" disabled>Delegation abschlie√üen</button>
        <div id="complete-result"></div>
    </div>

    <div class="step">
        <h3>4. Kalender-Event erstellen</h3>
        <button id="btn-create-event" class="btn-primary" disabled>Test-Event erstellen</button>
        <div id="event-result"></div>
    </div>

    <div class="step">
        <h3>Debug Log</h3>
        <pre id="debug-log"></pre>
        <button id="btn-clear-log" class="btn-secondary">Log l√∂schen</button>
    </div>

    <script>
        let prepareData = null;
        let delegationResult = null;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debug-log');
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[Delegation Test] ${message}`);
        }

        function showStatus(elementId, message, type = 'warning') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function showResult(elementId, data) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        // 1. Check login status
        document.getElementById('btn-check-login').addEventListener('click', async () => {
            try {
                log('Checking login status...');
                const response = await fetch('http://localhost:8787/me', { 
                    credentials: 'include' 
                });
                const data = await response.json();
                
                if (data.ok) {
                    showStatus('login-status', `Eingeloggt: ${data.pubkey}`, 'success');
                    document.getElementById('btn-prepare').disabled = false;
                    log(`Login OK: ${data.pubkey}`);
                } else {
                    showStatus('login-status', 'Nicht eingeloggt - bitte erst in der Hauptapp anmelden', 'error');
                    log('Not logged in');
                }
            } catch (err) {
                showStatus('login-status', `Fehler: ${err.message}`, 'error');
                log(`Login check failed: ${err.message}`);
            }
        });

        // 2. Prepare delegation
        document.getElementById('btn-prepare').addEventListener('click', async () => {
            try {
                log('Preparing delegation for kind 31923...');
                const response = await fetch('http://localhost:8787/delegation/prepare?kind=31923', {
                    credentials: 'include'
                });
                prepareData = await response.json();
                
                if (response.ok) {
                    showResult('prepare-result', prepareData);
                    document.getElementById('btn-complete').disabled = false;
                    log(`Delegation prepared. Message to sign: ${prepareData.delegationMessage}`);
                } else {
                    showStatus('prepare-result', `Fehler: ${prepareData.error}`, 'error');
                    log(`Prepare failed: ${prepareData.error}`);
                }
            } catch (err) {
                showStatus('prepare-result', `Fehler: ${err.message}`, 'error');
                log(`Prepare failed: ${err.message}`);
            }
        });

        // 3. Complete delegation
        document.getElementById('btn-complete').addEventListener('click', async () => {
            if (!prepareData) {
                alert('Bitte erst Delegation vorbereiten!');
                return;
            }

            try {
                log('Requesting signature from user...');
                
                if (!window.nostr) {
                    throw new Error('NIP-07 Extension nicht gefunden. Bitte nos2x-fox oder √§hnliche Extension installieren.');
                }

                // Show user what they're signing
                const userConfirmed = confirm(
                    `M√∂chten Sie diese Delegation signieren?\n\n` +
                    `Nachricht: ${prepareData.delegationMessage}\n\n` +
                    `Dies erlaubt dem Server, Kalender-Events in Ihrem Namen zu erstellen.`
                );

                if (!userConfirmed) {
                    log('User cancelled delegation signing');
                    return;
                }

                // Sign the delegation message
                let signature;
                if (window.nostr.signSchnorr) {
                    log('Using signSchnorr for delegation...');
                    const messageBytes = new TextEncoder().encode(prepareData.delegationMessage);
                    signature = await window.nostr.signSchnorr(messageBytes);
                } else {
                    // Fallback: use signEvent and extract signature
                    log('signSchnorr not available, using signEvent fallback...');
                    const tempEvent = {
                        kind: 1,
                        content: prepareData.delegationMessage,
                        created_at: Math.floor(Date.now() / 1000),
                        tags: [['t', 'delegation-signature']],
                        pubkey: await window.nostr.getPublicKey()
                    };
                    const signedEvent = await window.nostr.signEvent(tempEvent);
                    signature = signedEvent.sig;
                }

                log(`Got signature: ${signature}`);

                // Send signature to server
                const response = await fetch('http://localhost:8787/delegation/complete', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ signature })
                });

                delegationResult = await response.json();

                if (response.ok) {
                    showResult('complete-result', delegationResult);
                    document.getElementById('btn-create-event').disabled = false;
                    log('Delegation completed successfully!');
                } else {
                    showStatus('complete-result', `Fehler: ${delegationResult.error}`, 'error');
                    log(`Complete failed: ${delegationResult.error}`);
                }

            } catch (err) {
                showStatus('complete-result', `Fehler: ${err.message}`, 'error');
                log(`Complete failed: ${err.message}`);
            }
        });

        // 4. Create test event
        document.getElementById('btn-create-event').addEventListener('click', async () => {
            try {
                log('Creating test calendar event...');
                
                const eventData = {
                    title: 'Test Event via Delegation',
                    start: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 1 week from now
                    end: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000 + 2 * 60 * 60 * 1000).toISOString(), // 2 hours later
                    location: 'Test Location',
                    description: 'This is a test event created via NIP-26 delegation',
                    d: `test-${Date.now()}`
                };

                const response = await fetch('http://localhost:8787/calendar/event', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData)
                });

                const result = await response.json();

                if (response.ok) {
                    showResult('event-result', result);
                    log('Test event created successfully!');
                } else {
                    showStatus('event-result', `Fehler: ${result.error}`, 'error');
                    log(`Event creation failed: ${result.error}`);
                }

            } catch (err) {
                showStatus('event-result', `Fehler: ${err.message}`, 'error');
                log(`Event creation failed: ${err.message}`);
            }
        });

        // Clear log
        document.getElementById('btn-clear-log').addEventListener('click', () => {
            document.getElementById('debug-log').textContent = '';
        });

        // Initialize
        log('NIP-26 Delegation Test Tool loaded');
        document.getElementById('btn-check-login').click();
    </script>
</body>
</html>