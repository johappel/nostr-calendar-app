<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPress Simulation - Nostr Calendar Integration</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            margin: 0; 
            padding: 0; 
            background: #f1f1f1; 
        }
        .wp-header { 
            background: #23282d; 
            color: white; 
            padding: 10px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .wp-logo { font-size: 20px; font-weight: bold; }
        .wp-user-info { font-size: 14px; }
        .wp-content { 
            max-width: 1200px; 
            margin: 20px auto; 
            padding: 0 20px; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .wp-admin-bar { 
            background: #32373c; 
            color: white; 
            padding: 8px 20px; 
            font-size: 13px; 
            border-bottom: 1px solid #464b50; 
        }
        .calendar-section { 
            padding: 30px; 
        }
        .wp-button { 
            background: #0073aa; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px; 
            margin: 5px; 
        }
        .wp-button:hover { background: #005a87; }
        .wp-button.secondary { background: #666; }
        .wp-button.secondary:hover { background: #555; }
        .status { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 4px; 
            border-left: 4px solid #0073aa; 
        }
        .success { border-left-color: #46b450; background: #ecf7ed; }
        .error { border-left-color: #dc3232; background: #fbeaea; }
        .warning { border-left-color: #ffb900; background: #fff8e5; }
        .info { border-left-color: #0073aa; background: #e5f5fa; }
        .token-display { 
            background: #f9f9f9; 
            border: 1px solid #ddd; 
            padding: 15px; 
            border-radius: 4px; 
            margin: 15px 0; 
            font-family: monospace; 
            font-size: 12px; 
            word-break: break-all; 
        }
        .integration-demo { 
            border: 2px dashed #0073aa; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            background: #f8fcff; 
        }
        .step { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            background: white; 
        }
        .step h3 { margin-top: 0; color: #23282d; }
        .step-number { 
            background: #0073aa; 
            color: white; 
            width: 30px; 
            height: 30px; 
            border-radius: 50%; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            margin-right: 10px; 
        }
    </style>
</head>
<body>
    <!-- WordPress Header -->
    <div class="wp-header">
        <div class="wp-logo">üè¢ Meine WordPress Website</div>
        <div class="wp-user-info" id="wp-user-info">
            Angemeldet als: <strong>max.mustermann</strong> | 
            <a href="#" style="color: #0073aa;" onclick="logout()">Abmelden</a>
        </div>
    </div>
    
    <!-- WordPress Admin Bar -->
    <div class="wp-admin-bar">
        Dashboard | Beitr√§ge | Seiten | Medien | <strong>üìÖ Kalender</strong> | Benutzer | Einstellungen
    </div>

    <!-- Main Content -->
    <div class="wp-content">
        <div class="calendar-section">
            <h1>üìÖ Nostr Calendar Integration</h1>
            <p>Diese Seite simuliert eine WordPress-Installation mit dem Nostr Calendar SSO Plugin.</p>
            
            <!-- Integration Demo -->
            <div class="integration-demo">
                <h2>üîó WordPress ‚Üî Nostr Calendar Integration</h2>
                <p><strong>Szenario:</strong> Ein WordPress-User m√∂chte direkt aus WordPress heraus Events in der Nostr Calendar App erstellen, ohne sich separat anmelden zu m√ºssen.</p>
            </div>

            <!-- Step-by-Step Demo -->
            <div class="step">
                <h3><span class="step-number">1</span>WordPress User ist angemeldet</h3>
                <div id="wp-status" class="status info">
                    ‚úÖ WordPress User: <strong>max.mustermann</strong><br>
                    üìß E-Mail: max.mustermann@example.com<br>
                    üè† Website: <?= htmlspecialchars($_SERVER['HTTP_HOST'] ?? 'example.com') ?><br>
                    ‚è∞ Angemeldet seit: <?= date('d.m.Y H:i') ?>
                </div>
            </div>

            <div class="step">
                <h3><span class="step-number">2</span>SSO Token generieren</h3>
                <p>Das WordPress Plugin generiert einen sicheren Token f√ºr die Nostr Calendar App:</p>
                <button id="btn-generate-token" class="wp-button">üîë WordPress SSO Token generieren</button>
                <div id="token-result"></div>
            </div>

            <div class="step">
                <h3><span class="step-number">3</span>Zur Nostr Calendar App weiterleiten</h3>
                <p>Mit dem Token kann der User automatisch in der Nostr Calendar App angemeldet werden:</p>
                <button id="btn-open-calendar" class="wp-button" disabled>üìÖ Nostr Calendar √∂ffnen (SSO)</button>
                <button id="btn-open-calendar-iframe" class="wp-button secondary" disabled>üì± Als iFrame einbetten</button>
            </div>

            <div class="step" id="iframe-container" style="display: none;">
                <h3><span class="step-number">4</span>Eingebettete Nostr Calendar</h3>
                <div id="calendar-iframe-wrapper">
                    <!-- iFrame wird hier eingef√ºgt -->
                </div>
            </div>

            <!-- WordPress Plugin Shortcode Simulation -->
            <div class="integration-demo">
                <h3>üìù WordPress Shortcode Integration</h3>
                <p>In WordPress k√∂nnte der Kalender einfach per Shortcode eingebettet werden:</p>
                <code>[nostr_calendar]</code>
                
                <div style="margin-top: 15px;">
                    <button id="btn-shortcode-demo" class="wp-button">Shortcode Demo anzeigen</button>
                </div>
            </div>

            <!-- Debug Information -->
            <div class="step">
                <h3>üîß Debug & Integration Info</h3>
                <div id="debug-info" class="token-display">
                    Klicken Sie auf "Token generieren" um Debug-Informationen zu sehen...
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentToken = null;
        const calendarAppUrl = 'http://localhost:8787';

        // WordPress User Simulation
        const wpUser = {
            id: 1001,
            username: 'max.mustermann',
            email: 'max.mustermann@example.com',
            display_name: 'Max Mustermann',
            roles: ['subscriber'],
            site_url: window.location.origin
        };

        // Token Generation Simulation (wie WordPress Plugin)
        function generateWordPressToken() {
            const timestamp = Math.floor(Date.now() / 1000);
            const expires = timestamp + (2 * 3600); // 2 Stunden
            
            const payload = {
                wp_user_id: wpUser.id,
                wp_username: wpUser.username,
                wp_email: wpUser.email,
                wp_display_name: wpUser.display_name,
                wp_roles: wpUser.roles,
                timestamp: timestamp,
                expires: expires,
                wp_site_url: wpUser.site_url
            };

            // Simulation: In echt w√ºrde WordPress das mit HMAC signieren
            const tokenData = btoa(JSON.stringify(payload));
            const mockSignature = 'demo_signature_' + Math.random().toString(36).substr(2, 16);
            
            return tokenData + '.' + mockSignature;
        }

        // Event Handlers
        document.getElementById('btn-generate-token').addEventListener('click', function() {
            const token = generateWordPressToken();
            currentToken = token;
            
            const tokenResult = document.getElementById('token-result');
            tokenResult.innerHTML = `
                <div class="status success">
                    ‚úÖ Token erfolgreich generiert!
                </div>
                <div class="token-display">
                    <strong>SSO Token:</strong><br>
                    ${token.substring(0, 100)}...<br>
                    <small>G√ºltig f√ºr 2 Stunden</small>
                </div>
            `;
            
            // Buttons aktivieren
            document.getElementById('btn-open-calendar').disabled = false;
            document.getElementById('btn-open-calendar-iframe').disabled = false;
            
            // Debug Info
            const debugInfo = document.getElementById('debug-info');
            const payload = JSON.parse(atob(token.split('.')[0]));
            debugInfo.innerHTML = `
                <strong>Token Payload:</strong><br>
                ${JSON.stringify(payload, null, 2)}<br><br>
                <strong>Calendar App URL:</strong><br>
                ${calendarAppUrl}/wp-sso?token=${encodeURIComponent(token)}
            `;
        });

        document.getElementById('btn-open-calendar').addEventListener('click', function() {
            if (!currentToken) {
                alert('Bitte erst Token generieren!');
                return;
            }
            
            const ssoUrl = `${calendarAppUrl}/wp-sso?token=${encodeURIComponent(currentToken)}`;
            window.open(ssoUrl, '_blank');
        });

        document.getElementById('btn-open-calendar-iframe').addEventListener('click', function() {
            if (!currentToken) {
                alert('Bitte erst Token generieren!');
                return;
            }
            
            const ssoUrl = `${calendarAppUrl}/wp-sso?token=${encodeURIComponent(currentToken)}`;
            const iframeContainer = document.getElementById('iframe-container');
            const wrapper = document.getElementById('calendar-iframe-wrapper');
            
            wrapper.innerHTML = `
                <div style="border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                    <div style="background: #f9f9f9; padding: 10px; border-bottom: 1px solid #ddd;">
                        <strong>üìÖ Eingebettete Nostr Calendar</strong>
                        <button onclick="document.getElementById('iframe-container').style.display='none'" 
                                style="float: right; background: #dc3232; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                            Schlie√üen
                        </button>
                    </div>
                    <iframe src="${ssoUrl}" 
                            width="100%" 
                            height="600" 
                            frameborder="0"
                            style="display: block;">
                    </iframe>
                </div>
            `;
            
            iframeContainer.style.display = 'block';
        });

        document.getElementById('btn-shortcode-demo').addEventListener('click', function() {
            alert('In WordPress w√ºrde hier automatisch ein Token generiert und der Kalender eingebettet werden!\\n\\nShortcode: [nostr_calendar]\\nResultat: Eingebetteter Kalender mit automatischer SSO-Anmeldung');
        });

        function logout() {
            if (confirm('M√∂chten Sie sich von WordPress abmelden?')) {
                alert('Logout-Simulation: In echt w√ºrde hier die WordPress Session beendet werden.');
                // window.location.href = '/wp-login.php?action=logout';
            }
        }

        // Initial Status
        console.log('WordPress SSO Demo geladen');
        console.log('Simulierter User:', wpUser);
    </script>
</body>
</html>